@model ShoesEcommerce.Models.Orders.Order

@{
    ViewData["Title"] = "Thanh toán VNPay";
    var totalAmount = Model.TotalAmount;
    var subtotal = Model.OrderDetails?.Sum(od => od.Quantity * od.UnitPrice) ?? Model.TotalAmount;
    var discountAmount = subtotal - totalAmount;
}

<div class="vnpay-page">
    <div class="vnpay-breadcrumb">
        <a href="@Url.Action("Index", "Home")">Trang chủ</a>
        <span>/</span>
        <a href="@Url.Action("Index", "Cart")">Giỏ hàng</a>
        <span>/</span>
        <strong>Thanh toán VNPay</strong>
    </div>

    <div class="vnpay-layout">
        <section class="card clean-card">
            <header class="card-header">
                <div class="card-title">
                    <div class="logo-chip">
                        <img src="https://vnpay.vn/s1/statics.vnpay.vn/2023/9/06ncktiwd6dc1694418196384.png" alt="VNPay" />
                    </div>
                    <div>
                        <p class="eyebrow">Thanh toán an toàn</p>
                        <h1>VNPay Checkout</h1>
                        <p class="muted">Thẻ nội địa, Visa, MasterCard hoặc QR</p>
                    </div>
                </div>
                <div class="pill">@totalAmount.ToString("N0") đ</div>
            </header>

            <div class="card-grid">
                <div class="card-block">
                    <div class="info-pair">
                        <span class="muted">Mã đơn hàng</span>
                        <span class="strong">#@Model.Id</span>
                    </div>
                    <div class="info-pair">
                        <span class="muted">Ngày tạo</span>
                        <span class="strong">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                    <div class="info-pair">
                        <span class="muted">Trạng thái</span>
                        <span class="status-chip">Chờ thanh toán</span>
                    </div>
                </div>

                <div class="card-block">
                    <p class="muted">Hỗ trợ:</p>
                    <div class="method-tags">
                        <span><i class="fas fa-credit-card"></i> ATM nội địa</span>
                        <span><i class="fab fa-cc-visa"></i> Visa</span>
                        <span><i class="fab fa-cc-mastercard"></i> MasterCard</span>
                        <span><i class="fas fa-qrcode"></i> QR Code</span>
                    </div>
                </div>
            </div>

            <form asp-action="VnPayCheckout" asp-controller="Payment" method="post" id="vnpayForm" class="pay-row">
                <input type="hidden" name="orderId" value="@Model.Id" />
                <input type="hidden" name="amount" value="@Model.TotalAmount" />

                <div class="secure-note">
                    <i class="fas fa-shield-alt"></i>
                    <span>Giao dịch được bảo mật bởi VNPay</span>
                </div>

                <button type="submit" class="btn-primary" id="vnpayPayBtn">
                    <span>Thanh toán @totalAmount.ToString("N0") đ</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </form>

            <footer class="card-footer">
                <a class="ghost-link" href="@Url.Action("Index", "Cart")">
                    <i class="fas fa-arrow-left"></i> Quay lại giỏ hàng
                </a>
            </footer>
        </section>

        <aside class="card summary-card clean-card">
            <div class="summary-head">
                <h3>Tóm tắt đơn hàng</h3>
                <span class="muted">@Model.OrderDetails?.Count() ?? 0 sản phẩm</span>
            </div>

            @if (Model.OrderDetails != null && Model.OrderDetails.Any())
            {
                <div class="summary-list">
                    @foreach (var item in Model.OrderDetails)
                    {
                        <div class="summary-item">
                            <div class="thumb">
                                <img src="@(item.ProductVariant?.ImageUrl ?? "/images/no-image.svg")" alt="@(item.ProductVariant?.Product?.Name ?? "Sản phẩm")" onerror="this.src='/images/no-image.svg'" />
                                <span class="badge">@item.Quantity</span>
                            </div>
                            <div class="summary-info">
                                <div class="title">@(item.ProductVariant?.Product?.Name ?? "Sản phẩm")</div>
                                <div class="muted">@(item.ProductVariant?.Color ?? "") · @(item.ProductVariant?.Size ?? "")</div>
                            </div>
                            <div class="price">@((item.Quantity * item.UnitPrice).ToString("N0")) đ</div>
                        </div>
                    }
                </div>
            }

            <div class="divider"></div>

            <div class="totals">
                <div class="row">
                    <span class="muted">Tạm tính</span>
                    <span>@subtotal.ToString("N0") đ</span>
                </div>
                @if (discountAmount > 0)
                {
                    <div class="row success">
                        <span>Giảm giá</span>
                        <span>-@discountAmount.ToString("N0") đ</span>
                    </div>
                }
                <div class="row">
                    <span class="muted">Phí vận chuyển</span>
                    <span class="success">Miễn phí</span>
                </div>
            </div>

            <div class="divider"></div>

            <div class="total-row">
                <span>Tổng cộng</span>
                <span class="grand-total">@totalAmount.ToString("N0") đ</span>
            </div>
        </aside>
    </div>
</div>

@section Styles {
<style>
    :root {
        --bg: #f5f5f5;
        --card: #ffffff;
        --text: #1a1a1a;
        --muted: #6b7280;
        --border: #e5e7eb;
        --accent: #c41e3a;
        --dark: #1a1a1a;
        --radius: 12px;
        --shadow: 0 10px 30px rgba(0,0,0,0.06);
    }

    .vnpay-page { max-width: 1100px; margin: 0 auto; padding: 32px 20px 60px; }

    .vnpay-breadcrumb { display: flex; gap: 10px; align-items: center; font-size: 14px; color: var(--muted); margin-bottom: 20px; }
    .vnpay-breadcrumb a { color: var(--muted); text-decoration: none; }
    .vnpay-breadcrumb strong { color: var(--text); }

    .vnpay-layout { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 20px; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .clean-card { padding: 24px; }

    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 12px; }
    .card-title { display: flex; gap: 12px; align-items: center; }
    .logo-chip { width: 46px; height: 46px; border-radius: 10px; background: #f3f4f6; display: grid; place-items: center; }
    .logo-chip img { height: 22px; filter: grayscale(1); }
    .eyebrow { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); margin: 0; }
    .card-header h1 { font-size: 22px; margin: 2px 0 4px; color: var(--text); }
    .muted { color: var(--muted); font-size: 14px; }
    .pill { background: var(--dark); color: #fff; padding: 10px 14px; border-radius: 999px; font-weight: 600; }

    .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px; margin: 12px 0 6px; }
    .card-block { border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; background: #fafafa; }
    .info-pair { display: flex; justify-content: space-between; padding: 8px 0; }
    .info-pair .strong { font-weight: 600; color: var(--text); }
    .status-chip { background: #fff4e5; color: #b45309; padding: 6px 10px; border-radius: 999px; font-weight: 600; font-size: 13px; }

    .method-tags { display: flex; flex-wrap: wrap; gap: 8px; }
    .method-tags span { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 999px; background: #f3f4f6; font-size: 13px; color: var(--text); }
    .method-tags i { color: var(--accent); }

    .pay-row { display: grid; gap: 12px; margin-top: 12px; align-items: center; }
    .secure-note { display: inline-flex; align-items: center; gap: 8px; color: var(--muted); font-size: 14px; }
    .secure-note i { color: var(--accent); }

    .btn-primary { width: 100%; display: inline-flex; justify-content: center; align-items: center; gap: 10px; padding: 14px 18px; background: var(--accent); color: #fff; border: none; border-radius: 10px; font-weight: 700; font-size: 15px; letter-spacing: 0.01em; transition: transform 0.15s ease, box-shadow 0.15s ease; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 12px 24px rgba(196, 30, 58, 0.2); }
    .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none; }

    .card-footer { margin-top: 10px; }
    .ghost-link { color: var(--muted); text-decoration: none; font-weight: 600; }
    .ghost-link:hover { color: var(--text); }

    .summary-card { align-self: start; }
    .summary-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .summary-list { display: flex; flex-direction: column; gap: 12px; }
    .summary-item { display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; }
    .thumb { position: relative; width: 56px; height: 56px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); background: #f3f4f6; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; }
    .badge { position: absolute; top: -6px; right: -6px; background: var(--dark); color: #fff; padding: 3px 7px; border-radius: 999px; font-size: 11px; font-weight: 700; }
    .summary-info .title { font-weight: 600; color: var(--text); font-size: 14px; }
    .price { font-weight: 600; color: var(--text); white-space: nowrap; }

    .divider { height: 1px; background: var(--border); margin: 14px 0; }

    .totals .row { display: flex; justify-content: space-between; padding: 6px 0; color: var(--text); }
    .totals .row.success { color: #059669; }
    .totals .row .success { color: #059669; }

    .total-row { display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 18px; color: var(--text); }
    .grand-total { color: var(--accent); font-size: 22px; }

    @media (max-width: 992px) {
        .vnpay-layout { grid-template-columns: 1fr; }
        .summary-card { position: static; }
    }

    @media (max-width: 640px) {
        .card-header { flex-direction: column; align-items: flex-start; }
        .pill { width: 100%; text-align: center; }
        .pay-row { grid-template-columns: 1fr; }
        .card { padding: 18px; }
    }
</style>
}

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('vnpayForm');
    const payBtn = document.getElementById('vnpayPayBtn');
    if (!form || !payBtn) return;

    form.addEventListener('submit', function() {
        payBtn.disabled = true;
        payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Đang chuyển hướng...</span>';
    });
});
</script>
}
